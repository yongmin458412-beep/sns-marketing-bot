name: SNS Marketing Bot - Daily Run

on:
  # 1일 3회 자동 실행 (KST 기준: 09:00, 14:00, 20:00)
  schedule:
    - cron: '0 0 * * *'   # UTC 00:00 = KST 09:00
    - cron: '0 5 * * *'   # UTC 05:00 = KST 14:00
    - cron: '0 11 * * *'  # UTC 11:00 = KST 20:00

  # 수동 실행 (GitHub UI에서 트리거)
  workflow_dispatch:
    inputs:
      source_url:
        description: '소싱 URL (비워두면 골드박스)'
        required: false
        default: ''
      max_products:
        description: '처리할 최대 상품 수'
        required: false
        default: '3'
      monitor_comments:
        description: '댓글 모니터링 활성화'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
  INSTAGRAM_USERNAME: ${{ secrets.INSTAGRAM_USERNAME }}
  INSTAGRAM_PASSWORD: ${{ secrets.INSTAGRAM_PASSWORD }}
  COUPANG_ACCESS_KEY: ${{ secrets.COUPANG_ACCESS_KEY }}
  COUPANG_SECRET_KEY: ${{ secrets.COUPANG_SECRET_KEY }}
  COUPANG_PARTNER_ID: ${{ secrets.COUPANG_PARTNER_ID }}

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      # 1. 코드 체크아웃
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Python 설정
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # 3. 시스템 의존성 설치
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg fonts-nanum
          # Playwright 브라우저 설치
          pip install playwright
          playwright install chromium
          playwright install-deps chromium

      # 4. Python 패키지 설치
      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      # 5. 이전 세션 데이터 복원 (캐시)
      - name: Restore session data
        uses: actions/cache@v4
        with:
          path: |
            sessions/
            data/bot_database.db
          key: bot-session-${{ github.run_number }}
          restore-keys: |
            bot-session-

      # 6. 봇 실행
      - name: Run automation pipeline
        run: |
          python -c "
          import asyncio
          from core.pipeline import AutomationPipeline

          async def main():
              pipeline = AutomationPipeline()
              result = await pipeline.run_full_pipeline(
                  source_url='${{ github.event.inputs.source_url }}' or None,
                  max_products=int('${{ github.event.inputs.max_products }}' or '3'),
                  monitor_comments='${{ github.event.inputs.monitor_comments }}' != 'false',
                  monitor_duration=30
              )
              print(f'Result: {result}')

          asyncio.run(main())
          "

      # 7. 세션 데이터 저장 (아티팩트)
      - name: Upload session artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bot-session-data
          path: |
            sessions/
            data/bot_database.db
          retention-days: 30

      # 8. 실패 시 Telegram 알림
      - name: Notify on failure
        if: failure()
        run: |
          python -c "
          from core.bot import TelegramNotifier
          notifier = TelegramNotifier()
          notifier.notify_error('GitHub Actions 실행 실패! Run #${{ github.run_number }}')
          "
